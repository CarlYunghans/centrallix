## $Id: Makefile.in,v 1.17 2005/03/14 20:41:24 gbeeley Exp $
## $Source: /srv/bld/centrallix-repo/centrallix-lib/Makefile.in,v $
##
## Centrallix-Lib Makefile
##
## This library is made available under the GNU Lesser General Public
## License, version 2.1.
##
## Copyright (C) 1998-2001 LightSys Technology Services, Inc.
##

@SET_MAKE@
SHELL = @SHELL@

srcdir = @srcdir@
top_srcdir = @top_srcdir@
prefix = @prefix@
exec_prefix = @exec_prefix@

bindir = @bindir@
sbindir = @sbindir@
libexecdir = @libexecdir@
datadir = @datadir@
sysconfdir = @sysconfdir@
sharedstatedir = @sharedstatedir@
localstatedir = @localstatedir@
libdir = @libdir@
infodir = @infodir@
mandir = @mandir@
includedir = @includedir@
top_builddir = .

VPATH=src:tests
EXEEXT = @EXEEXT@
OBJEXT = @OBJEXT@
PATH_SEPARATOR = @PATH_SEPARATOR@
AWK = @AWK@
CC = @CC@
STRIP = @STRIP@
AR = @AR@
RANLIB = @RANLIB@
INSTALL = @INSTALL@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_SCRIPT = @INSTALL_SCRIPT@
INSTALL_DATA = @INSTALL_DATA@

LIBS = @LIBS@

## CFLAGS.  "MTCFLAGS" is used exclusively by the MTASK module
## compilation.  DO NOT OPTIMIZE MTASK!!!!  It will cause it to
## stop working!!!
##
PROFILE=@PROFILE@
CFLAGS=@CFLAGS@ @DEFS@ -Iinclude -DCXLIB_INTERNAL -DNM_USE_SYSMALLOC -Wall $(PROFILE) -g
MTCFLAGS=@CFLAGS@ @DEFS@ -Iinclude -DCXLIB_INTERNAL -DNM_USE_SYSMALLOC -Wall $(PROFILE) -g -O0

XSTATICFILES=mtask.o mtlexer.o xarray.o xhash.o xstring.o mtsession.o newmalloc.o xhashqueue.o bdqs_transport.o xhandle.o xringqueue.o cxsec.o smmalloc.o
STATICFILES=$(patsubst %,src/%,$(XSTATICFILES))

XDYNAMICFILES=mtask.lo mtlexer.lo xarray.lo xhash.lo xstring.lo mtsession.lo newmalloc.lo xhashqueue.lo bdqs_transport.lo xhandle.lo xringqueue.lo cxsec.lo smmalloc.lo
DYNAMICFILES=$(patsubst %,src/%,$(XDYNAMICFILES))

INCLUDEFILES:=$(wildcard include/*.h)
INCLUDEFILES:=$(patsubst include/cxlibconfig-internal.h,,$(INCLUDEFILES))
INCLUDEFILES:=$(patsubst include/cxlibconfig-all.h,,$(INCLUDEFILES))

TESTFILES:=$(wildcard tests/test_*.c)
TESTPROGS:=$(patsubst %.c,%.bin,$(TESTFILES))

.SUFFIXES:	.c .o .lo

.PHONY: all
FINAL_TARGETS = @FINAL_TARGETS@
all:	${FINAL_TARGETS}

## By default highly optimize cxsec; it is the optimization of
## things that use cxsec that will degrade its usefulness a lot,
## but it is good for cxsec itself to be optimized.
src/cxsec.o: src/cxsec.c
	$(CC) $(CFLAGS) -c $< -o $@ -O4

src/cxsec.lo: src/cxsec.c
	$(CC) $(CFLAGS) -shared -fPIC -c $< -o $@ -O4

## MTask uses its own cflags because there are things we can't
## do to mtask or it will malfunction.
src/mtask.o: src/mtask.c
	$(CC) $(MTCFLAGS) -c $< -o $@

src/mtask.lo: src/mtask.c
	$(CC) $(MTCFLAGS) -shared -fPIC -c $< -o $@


## Normal rules for generating normal .o as well as relocatable
## objects (.lo) for .so libraries.
.c.lo:	$<
	$(CC) $(CFLAGS) -shared -fPIC -c $< -o $@

.c.o:	$<
	$(CC) $(CFLAGS) -c $< -o $@

libCentrallix.so:	$(DYNAMICFILES)
	$(CC) $(CFLAGS) -shared -fPIC -Wl,-soname,libCentrallix.so $(DYNAMICFILES) -o libCentrallix.so ${LIBS}

libCentrallix.a:	$(STATICFILES)
	$(AR) -r libCentrallix.a $(STATICFILES)
	$(AR) -s libCentrallix.a
	${RANLIB} libCentrallix.a

libStParse.so:		src/stparse.lo
	$(CC) $(CFLAGS) -shared -fPIC -Wl,-soname,libStParse.so src/stparse.lo -o libStParse.so ${LIBS}

libStParse.a:		src/stparse.o
	$(AR) -r libStParse.a src/stparse.o
	$(AR) -s libStParse.a
	${RANLIB} libStParse.a

install: all
	mkdir -p "$(includedir)/cxlib"
	$(INSTALL) -p $(INCLUDEFILES) "$(includedir)/cxlib"
	mkdir -p "$(libdir)"
	$(INSTALL) -p ${FINAL_TARGETS} "$(libdir)"
	@echo ""
	@echo "***************************************************************"
	@echo "Libraries have been installed in $(libdir)"
	@echo ""
	@echo "Please ensure that $(libdir) is in"
	@echo '$$LD_LIBRARY_PATH or added to /etc/ld.so.conf.'
	@echo "***************************************************************"
	@echo ""

%.bin:	%.c tests/t_driver.c libCentrallix.a
	$(CC) $(CFLAGS) tests/t_driver.c $< libCentrallix.a -o $@

.PHONY: test
test:	$(TESTPROGS)
	@printf "%-64.64s  %s\n" "Test Name" "Ops/sec"
	@printf "%-64.64s  %s\n" "----------------------------------------------------------------" "----------"
	@for PROG in $(TESTPROGS); do $$PROG; done 

.PHONY: clean
clean:
	@rm -f src/*.o src/*.lo $(TESTPROGS) ${FINAL_TARGETS} 2>/dev/null

distclean: clean
	@rm -f config.status config.cache config.log
	@rm -rf autom4te-*.cache/
	@rm -f config.h
	@rm -f include/cxlibconfig.h
	@rm -f include/cxlibconfig-internal.h
	@rm -f include/cxlibconfig-all.h
	@rm -f Makefile stamp-h
	@rm -f .depend

distreallyclean: distclean
	@rm -f configure
	@rm -f config.h.in
	@rm -f include/cxlibconfig.h.in
	@rm -f include/cxlibconfig-internal.h.in
	@rm -f include/cxlibconfig-all.h.in
	@rm -f install-sh

.PHONY: depend
depend: .depend

.depend: */*.[ch]
	@echo "Rebuilding dependencies..."
	@makedepend @DEFS@ -o.o -I include -f - src/*.c >.depend 2>/dev/null
	@makedepend @DEFS@ -o.lo -I include -f - src/*.c >>.depend 2>/dev/null

include .depend
